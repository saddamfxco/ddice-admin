<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <title>Ludo Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: "Segoe UI", Arial, sans-serif; background: #f8f9fa; margin: 0; padding: 0; }
    .wrapper { max-width: 960px; margin: 36px auto 24px auto; background: #fff; border-radius: 16px; box-shadow: 0 4px 24px #0001; padding:32px 16px 24px 16px; }
    h2 { color: #3c8dbc; text-align: center; margin-bottom: 18px; }
    table { width:100%; border-collapse:collapse; margin-top:18px;}
    th, td { border:1px solid #d1d5db; padding:9px 8px; text-align:center; }
    th { background: #f3f6fa; }
    td.used { background: #ffeaea; color:#d32f2f; }
    td.approved { background: #eaf6ff; color:#1976d2; }
    td.pending { background: #fffde7; color:#bfa100; }
    button { padding:6px 12px; border-radius:6px; border:none; cursor:pointer; font-size:15px;}
    .approve { background: #4caf50; color:#fff; }
    .reset { background: #dd4b39; color:#fff; }
    .paid { background: #4caf50; color:#fff; }
    .pending-btn { background: #bfa100; color:#fff; }
    .winner { color:#4caf50; font-weight:bold;}
    .small { font-size:13px; color:#888;}
    #admin-auth {text-align:center;margin:24px 0;}
    #admin-auth input {padding:7px 8px;font-size:16px;}
    .dashboard {margin-top:40px; background:#f9f9fc; border-radius:10px; padding:18px 12px;}
    .dashboard h3 {margin-top:0; color:#1d6fa5;}
    .refer-block {background:#e2f3e2; border-radius:8px; padding: 8px 10px; margin:20px 0;}
    .points-actions button {margin:0 4px;}
    @media (max-width: 700px) {
      .wrapper { padding: 8px 2px 10px 2px;}
      table, th, td { font-size: 13px;}
    }
    .timer-cell {color:#1b6c30;}
    .binance-id-copy {
      cursor:pointer;
      background: #f4f9ff;
      border-radius: 4px;
      padding: 2px 6px;
      transition: background .2s;
      display:inline-block;
    }
    .binance-id-copy:hover {
      background: #cce6ff;
    }
    .binance-id-copy.copied {
      background: #d1ffd8 !important;
      color: #156900 !important;
    }
    .message-panel {
      max-width: 400px;
      margin: 0 auto 30px auto;
      padding: 18px 12px 10px 12px;
      background: #f7f7f7;
      border-radius: 10px;
      box-shadow: 0 2px 8px #0002;
      text-align: center;
    }
    .message-panel input, .message-panel button {
      font-size: 1rem;
      padding: 6px 10px;
      margin-right: 6px;
      border: 1px solid #b5e7b2;
      border-radius: 3px;
    }
    .message-panel button {
      background: #4caf50;
      color: #fff;
      border: none;
    }
    .message-panel #status {
      font-size: .95rem;
      margin-top: 8px;
      color: #388e3c;
      height: 1.2em;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <!-- Global Message Sender Panel -->
    <div class="message-panel" id="global-message-panel" style="display:none;">
      <div>
        <input id="msg" placeholder="মেসেজ" autocomplete="off">
        <button id="send">Send</button>
      </div>
      <div id="status"></div>
    </div>
    <!-- End Message Sender -->
    <h2>Pending Players</h2>
    <div id="admin-auth" style="display:none;">
      <input type="email" id="adminEmail" placeholder="Admin Email">
      <input type="password" id="adminPass" placeholder="Password">
      <button onclick="adminLogin()">Log In</button>
      <div id="authMsg" style="color:#b71c1c;margin-top:7px;"></div>
    </div>
    <div id="pendingTable"></div>
    <h2 style="margin-top:32px;">Winners (Approve & Paid)</h2>
    <div id="winnersTable"></div>
    <h2 style="margin-top:32px;">All Users & Points</h2>
    <div id="usersTable"></div>
    <div class="dashboard" id="dashboard"></div>
    <div style="margin-top:40px; color:#b71c1c; text-align:center;">
      <b>Security Note:</b> Restrict access to this page in production.<br>
      Secure your Firebase database rules to allow only admin writes/reads.
    </div>
  </div>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <!-- Global Message Sender Script (latest modular SDK for this part only) -->
  <script type="module">
    import { initializeApp as newInitializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
    // Use the same config as compat
    const app = newInitializeApp({
      apiKey: "AIzaSyDLhqeEYZmHHjYB1TtyZndsQk2wUfIW37k",
      authDomain: "friend-dice-pay.firebaseapp.com",
      databaseURL: "https://friend-dice-pay-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "friend-dice-pay",
      storageBucket: "friend-dice-pay.appspot.com",
      messagingSenderId: "1079545705926",
      appId: "1:1079545705926:web:af3f21bfbad5f866b52ec7",
      measurementId: "G-EJNMR0CRCG"
    });
    const db = getDatabase(app);
    window.addEventListener('admin-auth-checked', e => {
      document.getElementById('global-message-panel').style.display = e.detail.isAdmin ? '' : 'none';
    });
    document.getElementById('send').onclick = async function() {
      const msg = document.getElementById('msg').value.trim();
      const status = document.getElementById('status');
      if (!msg) {
        status.textContent = "মেসেজ দিন!";
        status.style.color = "red";
        return;
      }
      try {
        await set(ref(db, 'site_global_notification'), {
          message: msg,
          timestamp: Date.now()
        });
        status.textContent = "পাঠানো হয়েছে!";
        status.style.color = "#388e3c";
        document.getElementById('msg').value = '';
        setTimeout(() => status.textContent = "", 1200);
      } catch (e) {
        status.textContent = "সমস্যা!";
        status.style.color = "red";
      }
    };
  </script>
  <!-- Main Admin Panel Script -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDLhqeEYZmHHjYB1TtyZndsQk2wUfIW37k",
      authDomain: "friend-dice-pay.firebaseapp.com",
      databaseURL: "https://friend-dice-pay-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "friend-dice-pay",
      storageBucket: "friend-dice-pay.appspot.com",
      messagingSenderId: "1079545705926",
      appId: "1:1079545705926:web:af3f21bfbad5f866b52ec7",
      measurementId: "G-EJNMR0CRCG"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const ADMIN_UID = "XvrwYBQG5tTdqmmrfkFymIl3rP63";
    let isAdmin = false;
    document.getElementById('pendingTable').innerHTML = `
      <div style="text-align:center;margin:20px 0 0 0;font-size:19px;">
        Checking admin authentication...
      </div>
    `;
    firebase.auth().onAuthStateChanged(function(user) {
      if(user && user.uid === ADMIN_UID) {
        isAdmin = true;
        document.getElementById('admin-auth').style.display = "none";
        loadAdminData();
      } else {
        isAdmin = false;
        document.getElementById('pendingTable').innerHTML = '';
        document.getElementById('winnersTable').innerHTML = '';
        document.getElementById('usersTable').innerHTML = '';
        document.getElementById('dashboard').innerHTML = '';
        document.getElementById('admin-auth').style.display = "";
      }
      window.dispatchEvent(new CustomEvent('admin-auth-checked', { detail: { isAdmin } }));
    });
    function adminLogin() {
      const email = document.getElementById('adminEmail').value.trim();
      const pass = document.getElementById('adminPass').value.trim();
      document.getElementById('authMsg').textContent = '';
      firebase.auth().signInWithEmailAndPassword(email, pass)
      .catch(err=>{
        document.getElementById('authMsg').textContent = err.message;
      });
    }
    function loadAdminData() {
      fetchAllPendingPlayers(renderPendingPlayers);
      db.ref('winners').on('value', snap => {
        const winners = snap.val() || {};
        renderWinners(winners);
      });
      db.ref('users').on('value', snap => {
        const users = snap.val() || {};
        renderUsersTable(users);
        renderDashboard(users);
      });
      setInterval(() => fetchAllPendingPlayers(renderPendingPlayers), 10000);
    }
    function fetchAllPendingPlayers(renderCb) {
      db.ref('users').once('value').then(snap => {
        let allPlayers = {};
        snap.forEach(userSnap => {
          const uid = userSnap.key;
          const pendingPlayers = userSnap.child('pendingPlayers').val() || {};
          for (const trxId in pendingPlayers) {
            allPlayers[uid + '___' + trxId] = {
              ...pendingPlayers[trxId],
              _uid: uid,
              _trxId: trxId
            };
          }
        });
        renderCb(allPlayers);
      });
    }
    // Pending Players WITHOUT Binance ID
    let pendingTimersInterval = null;
    let pendingPlayersList = {};
    function renderPendingPlayers(players) {
      pendingPlayersList = players;
      let html = `<table>
        <tr>
          <th>Trx ID</th>
          <th>Status</th>
          <th>Request Time</th>
          <th>Approve</th>
          <th>Mark Used</th>
          <th>User UID</th>
        </tr>`;
      for (const key in players) {
        const p = players[key];
        if (p.used) continue;
        let status = p.approved ? 'Approved' : 'Pending';
        let statusClass = p.approved ? 'approved' : 'pending';
        html += `<tr>
          <td>${p.trxId || p._trxId}</td>
          <td class="${statusClass}">${status}</td>
          <td class="timer-cell" id="timer-${p._uid}-${p._trxId}">--</td>
          <td>
            ${!p.approved ? `<button class="approve" onclick="approvePlayer('${p._uid}','${p._trxId}')">Approve</button>` : ''}
          </td>
          <td>
            <button class="reset" onclick="markUsed('${p._uid}','${p._trxId}')">Mark Used</button>
          </td>
          <td class="small">${p._uid}</td>
        </tr>`;
      }
      html += `</table>`;
      document.getElementById('pendingTable').innerHTML = html;
      startPendingTimers();
    }
    function startPendingTimers() {
      if (pendingTimersInterval) clearInterval(pendingTimersInterval);
      updatePendingTimers();
      pendingTimersInterval = setInterval(updatePendingTimers, 1000);
    }
    function updatePendingTimers() {
      const now = Date.now();
      for (const key in pendingPlayersList) {
        const p = pendingPlayersList[key];
        if (p.used) continue;
        let reqTime = p.time || 0;
        const cellId = `timer-${p._uid}-${p._trxId}`;
        const cell = document.getElementById(cellId);
        if (cell) {
          if (reqTime > 0) {
            let diff = Math.floor((now - reqTime));
            if (diff < 0) diff = 0;
            let seconds = Math.floor(diff / 1000) % 60;
            let minutes = Math.floor(diff / (60 * 1000)) % 60;
            let hours = Math.floor(diff / (60 * 60 * 1000));
            let timeStr = "";
            if (hours > 0) timeStr += hours + " ঘণ্টা ";
            if (minutes > 0 || hours > 0) timeStr += minutes + " মিনিট ";
            timeStr += seconds + " সেকেন্ড আগে";
            cell.textContent = timeStr;
          } else {
            cell.textContent = "Unknown";
          }
        }
      }
    }
    // Winners WITH Binance ID
    function renderWinners(winners) {
      let html = `<table>
        <tr>
          <th>Game ID</th>
          <th>Trx ID</th>
          <th>Binance ID</th>
          <th>Time</th>
          <th>Status</th>
          <th>Approve</th>
          <th>Set Paid</th>
          <th>Set Pending</th>
        </tr>`;
      if (winners) {
        Object.entries(winners).sort((a, b) => (b[1].time || 0) - (a[1].time || 0)).forEach(([gameId, w]) => {
          let d = w.time ? (new Date(w.time)).toLocaleString() : '';
          let statusText = "";
          if (!w.approved) statusText = `<span class="pending">Pending</span>`;
          else statusText = w.paid ? `<span class="paid">Paid</span>` : `<span class="pending">Pending</span>`;
          // Binance ID show with copy
          let binanceCell = '';
          if (w.binanceId) {
            binanceCell = `<span class="binance-id-copy" data-binance="${w.binanceId}" title="Click to copy">${w.binanceId}</span>`;
          } else {
            binanceCell = `<span style="color:#bbb;">—</span>`;
          }
          html += `<tr>
            <td>${gameId}</td>
            <td>${w.trxId || ""}</td>
            <td>${binanceCell}</td>
            <td>${d}</td>
            <td>${statusText}</td>
            <td>
              ${!w.approved ? `<button class="approve" onclick="approveWinner('${gameId}')">Approve</button>` : ''}
            </td>
            <td>
              ${w.approved && !w.paid ? `<button class="paid" onclick="setPaid('${gameId}')">Set Paid</button>` : ''}
            </td>
            <td>
              ${w.approved && w.paid ? `<button class="pending-btn" onclick="setPending('${gameId}')">Set Pending</button>` : ''}
            </td>
          </tr>`;
        });
      }
      html += `</table>`;
      document.getElementById('winnersTable').innerHTML = html;
      // Attach copy-to-clipboard for binanceId
      setTimeout(() => {
        document.querySelectorAll('.binance-id-copy').forEach(el => {
          el.onclick = function() {
            const binanceId = this.getAttribute('data-binance');
            if (navigator.clipboard) {
              navigator.clipboard.writeText(binanceId);
            } else {
              let tmp = document.createElement('input');
              tmp.value = binanceId;
              document.body.appendChild(tmp);
              tmp.select();
              document.execCommand('copy');
              document.body.removeChild(tmp);
            }
            this.classList.add('copied');
            this.innerText = 'Copied!';
            setTimeout(() => {
              this.classList.remove('copied');
              this.innerText = binanceId;
            }, 1200);
          };
        });
      }, 200);
    }
    function renderUsersTable(users) {
      let html = `<table>
        <tr>
          <th>UID</th>
          <th>Refer Code</th>
          <th>Refer Link</th>
          <th>Referred Users</th>
          <th>Approved Referrals</th>
          <th>Points</th>
        </tr>`;
      for(const uid in users) {
        const u = users[uid];
        const referLink = location.origin + "/signup?ref=" + (u.referCode || uid);
        const referredCount = u.referredUsers ? Object.keys(u.referredUsers).length : 0;
        const approvedCount = u.approvedReferrals ? Object.keys(u.approvedReferrals).length : 0;
        html += `<tr>
          <td class="small">${uid}</td>
          <td>${u.referCode || uid}</td>
          <td><input style="width:180px;font-size:12px" value="${referLink}" readonly></td>
          <td>${referredCount}</td>
          <td>${approvedCount}</td>
          <td>${u.points || 0}</td>
        </tr>`;
      }
      html += `</table>`;
      document.getElementById('usersTable').innerHTML = html;
    }
    function renderDashboard(users) {
      let totalPlayers = Object.keys(users).length;
      let totalApproved = 0, totalPoints = 0, topRef = [];
      let maxRef = 0;
      for(const uid in users) {
        const u = users[uid];
        if(u.pendingPlayers) {
          for(let k in u.pendingPlayers) {
            if(u.pendingPlayers[k].approved) totalApproved++;
          }
        }
        totalPoints += u.points || 0;
        const refCount = u.approvedReferrals ? Object.keys(u.approvedReferrals).length : 0;
        if(refCount > maxRef) {
          maxRef = refCount;
          topRef = [uid];
        } else if(refCount > 0 && refCount === maxRef) {
          topRef.push(uid);
        }
      }
      let html = `<h3>Dashboard</h3>
        <div>মোট প্লেয়ার: <b>${totalPlayers}</b></div>
        <div>মোট Approve হয়েছে: <b>${totalApproved}</b></div>
        <div>মোট রেফার কমিশন (পয়েন্ট): <b>${totalPoints}</b></div>
        <div>সর্বোচ্চ রেফারার: <b>${topRef.join(', ')||'N/A'}</b> (${maxRef} জন Approve)</div>
      `;
      document.getElementById('dashboard').innerHTML = html;
    }
    window.approvePlayer = function(uid, trxId) {
      if (confirm("Approve this player?")) {
        db.ref('users/' + uid + '/pendingPlayers/' + trxId).update({ approved: true })
        .then(() => {
          db.ref('users/' + uid).once('value').then(snap => {
            const user = snap.val();
            if (user && user.referredBy) {
              db.ref('users').orderByChild('referCode').equalTo(user.referredBy).once('value', snap2 => {
                snap2.forEach(refUserSnap => {
                  const refUid = refUserSnap.key;
                  db.ref('users/' + refUid + '/points').transaction(points => (points || 0) + 2);
                  db.ref('users/' + refUid + '/approvedReferrals/' + uid).set(true);
                });
              });
            }
            alert('Player approved!');
            fetchAllPendingPlayers(renderPendingPlayers);
          });
        })
        .catch(err => alert('Error: ' + err.message));
      }
    };
    window.markUsed = function(uid, trxId) {
      if (confirm("Mark this transaction as used?")) {
        db.ref('users/' + uid + '/pendingPlayers/' + trxId).update({ used: true })
        .then(() => {
          alert('Marked as used!');
          fetchAllPendingPlayers(renderPendingPlayers);
        })
        .catch(err => alert('Error: ' + err.message));
      }
    };
    window.approveWinner = function(gameId) {
      if (confirm("Approve this winner?")) {
        db.ref('winners/' + gameId).update({ approved: true })
        .then(() => alert('Winner approved!'))
        .catch(err => alert('Error: ' + err.message));
      }
    };
    window.setPaid = function(gameId) {
      if (confirm("Mark this winner as PAID?")) {
        db.ref('winners/' + gameId).update({ paid: true })
        .then(() => alert('Winner marked as PAID.'))
        .catch(err => alert('Error: ' + err.message));
      }
    };
    window.setPending = function(gameId) {
      if (confirm("Mark this winner as PENDING (not paid)?")) {
        db.ref('winners/' + gameId).update({ paid: false })
        .then(() => alert('Winner marked as PENDING.'))
        .catch(err => alert('Error: ' + err.message));
      }
    };
  </script>
</body>
</html>




 
